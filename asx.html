<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Eaglercraft BOT Client</title>
<style>
    body {
        background: #000;
        color: #0f0;
        font-family: monospace;
        text-align: center;
        padding-top: 30px;
        user-select: none;
    }
    input, button {
        background: #111;
        border: 1px solid #0f0;
        color: #0f0;
        padding: 8px;
        font-family: monospace;
        width: 260px;
        margin: 5px;
    }
</style>
</head>
<body>

<h1>Eaglercraft BOT Client</h1>
<p>BOT コンソールと連動するクライアントです。</p>

<input id="serverIP" placeholder="wss://server.example/" />
<br>
<button onclick="btnConnect()">サーバーに接続</button>

<!-- Eaglercraft を描画する canvas -->
<canvas id="game" width="960" height="540"></canvas>

<script src="eags-launcher.js"></script>  <!-- Eaglercraft 本体の JS 必須 -->

<script>
/* ============================================================
   Eaglercraft 本体のロード
   ============================================================ */
let glCanvas = document.getElementById("game");
let game;

/* Eaglercraft を起動 */
(async () => {
    game = await EaglercraftX(glCanvas);
})();

/* ============================================================
   ボタンからサーバー接続（テスト用）
   ============================================================ */
function btnConnect() {
    const ip = document.getElementById("serverIP").value;
    if (ip) joinServer(ip);
}

/* ============================================================
   サーバー接続処理（BOT / コンソール 両対応）
   ============================================================ */
function joinServer(ip) {
    if (!game) return;
    try {
        game.connectToServer(ip);
        console.log("[CLIENT] Connecting to:", ip);
    } catch(e) {
        console.log("[ERROR] connect failed:", e);
    }
}

/* ============================================================
   BOT メインループ
   ============================================================ */
window.botEnabled = false;

setInterval(() => {
    if (!window.botEnabled) return;
    if (!window.mc || !mc.thePlayer) return;

    // ----------- BOT の簡易動作（攻撃オート） -----------
    const ent = mc.theWorld?.loadedEntityList;
    if (!ent) return;

    for (let e of ent) {
        if (e !== mc.thePlayer) {
            // プレイヤーに向けて攻撃
            mc.thePlayer.swingItem();
            mc.playerController.attackEntity(mc.thePlayer, e);
            break;
        }
    }

}, 150);

/* ============================================================
   BOT / サーバー制御用 postMessage ハンドラ
   ============================================================ */
window.addEventListener("message", async (event) => {
    const data = event.data;

    /* ---- サーバー接続 ---- */
    if (data.action === "connect") {
        joinServer(data.ip);
        event.source.postMessage({ log: "サーバー接続中: " + data.ip }, "*");
    }

    /* ---- BOT 起動 ---- */
    if (data.action === "bot_start") {
        window.botEnabled = true;
        event.source.postMessage({ log: "BOT 起動" }, "*");
    }

    /* ---- BOT 停止 ---- */
    if (data.action === "bot_stop") {
        window.botEnabled = false;
        event.source.postMessage({ log: "BOT 停止" }, "*");
    }

    /* ---- チャット送信 ---- */
    if (data.action === "chat") {
        if (window.mc?.thePlayer) {
            mc.thePlayer.sendChatMessage(data.message);
            event.source.postMessage({ log: "チャット送信: " + data.message }, "*");
        } else {
            event.source.postMessage({ log: "チャット失敗 (mc 未初期化)" }, "*");
        }
    }
});
</script>

</body>
</html>
